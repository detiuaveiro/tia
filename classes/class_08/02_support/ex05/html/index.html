<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>DHT11</title>
  <meta name="author" content="MÃ¡rio Antunes">

  <script src="js/plotly-3.1.0.min.js" charset="utf-8"></script>
  <script src="js/paho-mqtt-min.js" charset="utf-8"></script>
  <script src="js/predict.js" charset="utf-8"></script>

  <style>
    body { font-family: sans-serif; padding: 10px; }
    #controls { margin-bottom: 15px; }
    #controls label { margin-left: 10px; }
    #controls input { width: 150px; }
    #status { margin-left: 15px; font-weight: bold; }
  </style>
</head>

<body>

  <div id="controls">
    <label for="ip">Broker IP:</label>
    <input type="text" id="ip" value="192.168.1.6">
    
    <label for="topic">Topic:</label>
    <input type="text" id="topic" value="deti/pico/dht11">
    
    <button id="connectBtn">Connect</button>
    <span id="status">Status: Disconnected</span>
  </div>

  <div id='plot' style='width:800px;height:600px;'></div>

  <script>
    let mqtt;
    const statusEl = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const ipInput = document.getElementById('ip');
    const topicInput = document.getElementById('topic');

    let trace_temp = {
      x:[], y: [],
      mode: 'lines+markers',
      type: 'scatter',
      name: 'Temperature',
      line: {color: 'red'} // Set line color to red
    };

    let trace_hum = {
      x:[], y: [],
      mode: 'lines+markers',
      type: 'scatter',
      name: 'Humidity',
      yaxis: 'y2',
      line: {color: 'blue'} // Set line color to blue
    };

    let data = [trace_temp, trace_hum];

    var layout = {
      title: {text: 'DHT11'},
      yaxis: {
        title: {
          text: 'Temperature',
          font: {color: 'red'}
        },
        tickfont: {color: 'red'},
        range: [10, 30]
      },
      yaxis2: {
        title: {
          text: 'Humidity',
          font: {color: 'blue'}
        },
        tickfont: {color: 'blue'},
        overlaying: 'y',
        side: 'right',
        range: [0, 100]
      }
    };

    Plotly.newPlot('plot', data, layout);

    // --- Connection Logic ---
    connectBtn.addEventListener('click', function() {
      if (mqtt && mqtt.isConnected()) {
        mqtt.disconnect();
      }
      
      let ip = ipInput.value;
      let topic = topicInput.value;
      
      statusEl.textContent = 'Status: Connecting...';
      
      mqtt = new Paho.MQTT.Client(ip, 9001, '');

      // set callback handlers
      mqtt.onConnectionLost = onConnectionLost;
      mqtt.onMessageArrived = onMessageArrived;

      let options = {
        timeout: 3, 
        onSuccess: () => onConnect(topic), // Pass topic to onConnect
        onFailure: onConnectFailure
      };
      
      mqtt.connect(options);
    });

    function onConnect(topic) {
      console.log('Connected...');
      statusEl.textContent = 'Status: Connected';
      mqtt.subscribe(topic);
    }

    function onConnectFailure(response) {
      console.log("Connection failed:", response.errorMessage);
      statusEl.textContent = 'Status: Connection Failed';
    }

    // called when the client loses its connection
    function onConnectionLost(responseObject) {
      statusEl.textContent = 'Status: Disconnected';
      if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:"+responseObject.errorMessage);
      }
    }

    // called when a message arrives
    function onMessageArrived(message) {
      let data;

      // 1. Parse the incoming JSON string
      try {
        data = JSON.parse(message.payloadString);
      } catch (e) {
        console.error("Failed to parse JSON:", e, message.payloadString);
        return; // Exit if JSON is invalid
      }

      // 2. Use the timestamp from the message payload
      let messageTime = new Date(data.ts * 1000);

      console.log("onMessageArrived(" + message.destinationName + "):", data);

      // 3. Update the plot's X-axis range
      let olderTime = new Date(messageTime.getTime() - 30000); // 30 seconds before
      let futureTime = new Date(messageTime.getTime() + 30000); // 30 seconds after

      let minuteView = {xaxis: { type: 'date', range: [olderTime, futureTime] }};
      Plotly.relayout('plot', minuteView);

      // 4. Prepare the data update
      let update;
      update = {
        x: [[messageTime]],
        y: [[data.t]]
      };
      Plotly.extendTraces('plot', update, [0]); // Update trace 0 (Temp)
      
      update = {
        x: [[messageTime]],
        y: [[data.h]]
      };
      Plotly.extendTraces('plot', update, [1]); // Update trace 1 (Hum)
    }
  </script>
</body>
</html>
